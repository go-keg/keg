{{/*
Copyright 2019-present Facebook Inc. All rights reserved.
This source code is licensed under the Apache 2.0 license found
in the LICENSE file in the root directory of this source tree.
*/}}

{{/* gotype: entgo.io/ent/entc/gen.Graph */}}

{{ define "gql_list" }}
{{ template "header" $ }}

{{ template "import" $ }}

import (
    "github.com/99designs/gqlgen/graphql"
    "golang.org/x/exp/slices"
    "context"
)

type customCollectFieldsArgs struct {
		path   []string
		fields []string
}

type CustomCollectFieldsOption func(args *customCollectFieldsArgs)

func WithPath(path ...string) CustomCollectFieldsOption {
		return func(args *customCollectFieldsArgs) {
				args.path = path
		}
}

func WithFields(fields ...string) CustomCollectFieldsOption {
		return func(args *customCollectFieldsArgs) {
				args.fields = fields
		}
}

{{ $gqlNodes := filterNodes $.Nodes (skipMode "type") }}
{{ range $node := $gqlNodes }}

{{ $receiver := print "_" $node.Receiver }}
{{ $query := $node.QueryName }}
// CollectFields tells the query-builder to eagerly load connected nodes by resolver context.
func ({{ $receiver }} *{{ $query }}) CustomCollectFields(ctx context.Context, opts ...CustomCollectFieldsOption) (*{{ $query }}, error) {
		args := customCollectFieldsArgs{}
		for _, opt := range opts {
				opt(&args)
		}
		fc := graphql.GetFieldContext(ctx)
    if fc == nil {
        return {{ $receiver }}, nil
    }
    if field := collectedField(ctx, args.path...); field != nil {
        if err := {{ $receiver }}.collectField(ctx, true, graphql.GetOperationContext(ctx), *field, args.path); err != nil {
            return nil, err
        }
    }
		if len(args.fields) > 0 && len({{ $receiver }}.ctx.Fields) > 0 {
				for _, field := range args.fields {
						if !slices.Contains({{ $receiver }}.ctx.Fields, field) {
								{{ $receiver }}.ctx.Fields = append({{ $receiver }}.ctx.Fields, field)
						}
				}
		}
    return {{ $receiver }}, nil
}

// AllCollectFields
func ({{ $receiver }} *{{ $query }}) AllCollectFields(ctx context.Context, opts ...CustomCollectFieldsOption) ([]*{{ $node.Name }}, error) {
	query, err := {{ $receiver }}.CustomCollectFields(ctx, opts...)
	if err != nil {
		return nil, err
	}
	return query.All(ctx)
}

// FirstCollectFields
func ({{ $receiver }} *{{ $query }}) FirstCollectFields(ctx context.Context, opts ...CustomCollectFieldsOption) (*{{ $node.Name }}, error) {
	query, err := {{ $receiver }}.CustomCollectFields(ctx, opts...)
	if err != nil {
		return nil, err
	}
	return query.First(ctx)
}

{{ $names := nodePaginationNames $node -}}
{{ $opt := print $names.Node "PaginateOption" }}
{{ $conn := $names.Connection }}
{{ $newPager := print "new" $names.Node "Pager" }}

{{ $list := print $names.Node "List" }}
// {{ $list }} is the list to {{ $names.Node }}.
type {{ $list }} struct {
		Nodes 			[]*{{ $names.Node }} 	`json:"nodes"`
		TotalCount 	int       						`json:"totalCount"`
}

// List executes the query and returns totalCount and nodes []*{{ $node.Name }}.
func ({{ $receiver }} *{{ $query }}) List(ctx context.Context, offset, limit int, opts ...{{ $opt }}) (*{{ $list }}, error) {
	pager, err := {{ $newPager }}(opts, false)
	if err != nil {
		return nil, err
	}
	if _, err = pager.applyFilter({{ $receiver }}); err != nil {
		return nil, err
	}
	conn := &{{ $list }}{}
	ignoredNodes := !hasCollectedField(ctx, nodesField)
	if hasCollectedField(ctx, totalCountField) {
		hasPagination := limit != 0
		if hasPagination || ignoredNodes {
			c := {{ $receiver }}.Clone()
			c.ctx.Fields = nil
			if conn.TotalCount, err = c.Count(ctx); err != nil {
				return nil, err
			}
		}
	}
	if ignoredNodes || (limit == 0) {
		return conn, nil
	}
	{{ $receiver }}.Offset(offset).Limit(limit)
	if field := collectedField(ctx, nodesField); field != nil {
		if err = {{ $receiver }}.collectField(ctx, limit == 1, graphql.GetOperationContext(ctx), *field, []string{nodesField}); err != nil {
			return nil, err
		}
	}
	conn.Nodes, err = pager.applyOrder({{ $receiver }}).All(ctx)
	if err != nil {
		return nil, err
	}
	return conn, nil
}

{{ end }}
{{ end }}
